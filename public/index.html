<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jury Game</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Jury Game</h1>

  <input id="username" placeholder="Enter username (AYAATGM for GM)">
  <button id="joinBtn">Join Game</button>

  <h2 id="jurorInfo"></h2>
  <h2 id="courtStatus"></h2>
  <h3>Phase: <span id="phase"></span></h3>
  <h3>Time left: <span id="timer"></span></h3>

  <ul id="votesList"></ul>

  <!-- GM file upload -->
  <div id="gmUpload" style="display:none;">
    <h3>Upload file (PDF/Evidence)</h3>
    <form id="uploadForm">
      <input type="file" name="file">
      <button type="submit">Upload</button>
    </form>
  </div>

  <!-- Show file links -->
  <div id="files"></div>

  <script>
    const socket = io();
    let jurorNumber = null;

    document.getElementById('joinBtn').onclick = () => {
      const username = document.getElementById('username').value.trim();
      if (username) socket.emit('join', username);
    };

    socket.on('joinedPlayer', (data) => {
      jurorNumber = data.jurorNumber;
      document.getElementById('jurorInfo').innerText =
        `You are Juror #${jurorNumber} (${data.role})`;
      document.getElementById('phase').innerText = data.phase;
      updateVotesList(data.publicVotes);
      updateTimer(data.timeLeft);
    });

    socket.on('joinedGM', (data) => {
      document.getElementById('gmUpload').style.display = 'block';
      document.getElementById('phase').innerText = data.phase;
      updateTimer(data.timeLeft);
    });

    socket.on('courtInSession', (msg) => {
      document.getElementById('courtStatus').innerText = msg;
    });

    socket.on('phaseUpdated', (phase) => {
      document.getElementById('phase').innerText = phase;
    });

    socket.on('updateVotes', updateVotesList);

    socket.on('timeUpdate', updateTimer);

    socket.on('timeUp', (msg) => {
      alert(msg);
    });

    socket.on('newFile', (url) => {
      const link = document.createElement('a');
      link.href = url;
      link.innerText = `Download Evidence`;
      link.target = '_blank';
      document.getElementById('files').appendChild(link);
      document.getElementById('files').appendChild(document.createElement('br'));
    });

    function updateVotesList(votes) {
      const ul = document.getElementById('votesList');
      ul.innerHTML = '';
      votes.forEach(v => {
        const li = document.createElement('li');
        li.innerText = v;
        ul.appendChild(li);
      });
    }

    function updateTimer(timeLeft) {
      const mins = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      document.getElementById('timer').innerText =
        `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    // GM file upload
    document.getElementById('uploadForm').onsubmit = async (e) => {
      e.preventDefault();
      const fileInput = document.querySelector('input[name="file"]');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      await fetch('/upload', { method: 'POST', body: formData });
      alert('File uploaded & shared!');
      fileInput.value = '';
    };
  </script>
</body>
</html>

